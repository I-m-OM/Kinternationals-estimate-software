generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  SALES
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(SALES)
  avatar    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  estimates        Estimate[]
  customers        Customer[]
  assignedProjects Project[]

  @@map("users")
}

model Customer {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String   @default("India")
  notes       String?
  isActive    Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User       @relation(fields: [createdById], references: [id])
  estimates Estimate[]

  @@map("customers")
}

model Category {
  id           String   @id @default(uuid())
  name         String   @unique
  slug         String   @unique
  description  String?
  parentId     String?
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id             String   @id @default(uuid())
  sku            String   @unique
  name           String
  description    String?
  categoryId     String
  unit           String   @default("piece")
  basePrice      Decimal  @db.Decimal(10, 2)
  costPrice      Decimal? @db.Decimal(10, 2)
  taxRate        Decimal  @default(18.00) @db.Decimal(5, 2)
  specifications Json?
  images         String[]
  isActive       Boolean  @default(true)
  stockQuantity  Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  category      Category       @relation(fields: [categoryId], references: [id])
  estimateItems EstimateItem[]

  @@map("products")
}

model Estimate {
  id                 String         @id @default(uuid())
  estimateNumber     String         @unique
  customerId         String
  userId             String
  title              String
  description        String?
  status             EstimateStatus @default(DRAFT)
  validUntil         DateTime?
  subtotal           Decimal        @default(0) @db.Decimal(12, 2)
  discountPercent    Decimal        @default(0) @db.Decimal(5, 2)
  discountAmount     Decimal        @default(0) @db.Decimal(10, 2)
  taxAmount          Decimal        @default(0) @db.Decimal(10, 2)
  total              Decimal        @default(0) @db.Decimal(12, 2)
  notes              String?
  termsAndConditions String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  customer Customer       @relation(fields: [customerId], references: [id])
  user     User           @relation(fields: [userId], references: [id])
  items    EstimateItem[]
  project  Project?

  @@map("estimates")
}

model EstimateItem {
  id             String   @id @default(uuid())
  estimateId     String
  productId      String?
  description    String
  quantity       Decimal  @db.Decimal(10, 2)
  unit           String
  unitPrice      Decimal  @db.Decimal(10, 2)
  taxRate        Decimal  @db.Decimal(5, 2)
  taxAmount      Decimal  @db.Decimal(10, 2)
  lineTotal      Decimal  @db.Decimal(12, 2)
  displayOrder   Int      @default(0)
  specifications Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])

  @@map("estimate_items")
}

model Project {
  id              String        @id @default(uuid())
  projectNumber   String        @unique
  estimateId      String        @unique
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime?
  endDate         DateTime?
  actualStartDate DateTime?
  actualEndDate   DateTime?
  progressPercent Int           @default(0)
  assignedToId    String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  estimate   Estimate @relation(fields: [estimateId], references: [id])
  assignedTo User?    @relation(fields: [assignedToId], references: [id])

  @@map("projects")
}